<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EGEM Makine Takip Sistemi - PLC Test Sayfasƒ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        .control-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
            border-left: 5px solid #3498db;
        }

        .section-title {
            font-size: 1.5rem;
            color: #2c3e50;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #34495e;
            font-size: 1.1rem;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .button-type-selector {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .button-type-option {
            flex: 1;
            padding: 15px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .button-type-option:hover {
            border-color: #3498db;
            background: #f8f9fa;
        }

        .button-type-option.selected {
            border-color: #3498db;
            background: #3498db;
            color: white;
        }

        .button-type-option input[type="radio"] {
            display: none;
        }

        .button-type-option label {
            cursor: pointer;
            margin: 0;
            font-weight: 600;
        }

        .plc-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .plc-button {
            background: white;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .plc-button:hover {
            border-color: #3498db;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .plc-button.active {
            border-color: #27ae60;
            background: #27ae60;
            color: white;
        }

        .plc-button.momentary:active {
            border-color: #e74c3c;
            background: #e74c3c;
            transform: scale(0.95);
        }
        
        .plc-button.momentary.active {
            border-color: #e74c3c;
            background: #e74c3c;
            color: white;
            transform: scale(0.95);
        }

        .button-label {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .plc-button.active .button-label {
            color: white;
        }

        .button-label-text {
            flex: 1;
        }

        .edit-button {
            background: none;
            border: none;
            color: #7f8c8d;
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            margin-left: 8px;
        }

        .edit-button:hover {
            background: rgba(0,0,0,0.1);
            color: #2c3e50;
        }

        .plc-button.active .edit-button {
            color: rgba(255,255,255,0.8);
        }

        .plc-button.active .edit-button:hover {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .button-type-button {
            background: none;
            border: none;
            color: #7f8c8d;
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 0.8rem;
            transition: all 0.2s ease;
            margin-left: 4px;
        }

        .button-type-button:hover {
            background: rgba(0,0,0,0.1);
            color: #2c3e50;
        }

        .plc-button.active .button-type-button {
            color: rgba(255,255,255,0.8);
        }

        .plc-button.active .button-type-button:hover {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .button-type-indicator {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 4px;
        }

        .button-type-indicator.toggle {
            background: #27ae60;
            color: white;
        }

        .button-type-indicator.momentary {
            background: #e74c3c;
            color: white;
        }

        .edit-input {
            background: white;
            border: 2px solid #3498db;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 1rem;
            font-weight: 600;
            width: 100%;
            outline: none;
        }

        .plc-button.active .edit-input {
            background: rgba(255,255,255,0.9);
            color: #2c3e50;
        }

        .button-address {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-bottom: 15px;
        }

        .plc-button.active .button-address {
            color: rgba(255,255,255,0.8);
        }

        .button-status {
            font-size: 0.8rem;
            padding: 5px 10px;
            border-radius: 15px;
            background: #ecf0f1;
            color: #7f8c8d;
            display: inline-block;
        }

        .plc-button.active .button-status {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .status-panel {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 30px;
        }

        .status-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .status-item:last-child {
            border-bottom: none;
        }

        .status-label {
            font-weight: 500;
        }

        .status-value {
            font-family: 'Courier New', monospace;
            background: rgba(255,255,255,0.1);
            padding: 2px 8px;
            border-radius: 4px;
        }

        .add-button {
            background: #3498db;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .add-button:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .remove-button {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            margin-top: 10px;
        }

        .remove-button:hover {
            background: #c0392b;
        }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .data-card {
            background: white;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .data-card:hover {
            border-color: #3498db;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .data-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .data-card-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .data-card-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #3498db;
            font-family: 'Courier New', monospace;
        }

        .data-card-unit {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-left: 5px;
        }

        .data-card-status {
            font-size: 0.8rem;
            padding: 4px 8px;
            border-radius: 12px;
            background: #ecf0f1;
            color: #7f8c8d;
        }

        .data-card-status.updated {
            background: #d5f4e6;
            color: #27ae60;
        }

        .data-card-status.error {
            background: #fadbd8;
            color: #e74c3c;
        }

        .data-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
        }

        .refresh-status {
            font-size: 0.9rem;
            color: #7f8c8d;
            padding: 8px 12px;
            background: #ecf0f1;
            border-radius: 6px;
        }

        .refresh-status.active {
            background: #d5f4e6;
            color: #27ae60;
        }

        .refresh-status.error {
            background: #fadbd8;
            color: #e74c3c;
        }

        @media (max-width: 768px) {
            .plc-buttons {
                grid-template-columns: 1fr;
            }
            
            .button-type-selector {
                flex-direction: column;
            }
            
            .main-content {
                padding: 20px;
            }

            .data-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>EGEM Makine Takip Sistemi</h1>
            <p>PLC Test Sayfasƒ±</p>
        </div>

        <div class="main-content">
            <div class="control-section">
                <h2 class="section-title">PLC Ayarlarƒ±</h2>
                
                <div class="form-group">
                    <label for="plcAddress">PLC Adresi:</label>
                    <input type="text" id="plcAddress" placeholder="√ñrn: 192.168.1.100" value="192.168.1.100">
                </div>


                <div class="form-group">
                    <label for="newButtonAddress">Yeni Buton Adresi:</label>
                    <select id="newButtonAddress" style="width: 100%; padding: 12px 15px; border: 2px solid #e1e8ed; border-radius: 8px; font-size: 1rem;">
                        <option value="">Adres se√ßin...</option>
                        <optgroup label="DB1 - Temel Kontroller">
                            <option value="DB1.DBX0.0">DB1.DBX0.0 (Coil 0)</option>
                            <option value="DB1.DBX0.1">DB1.DBX0.1 (Coil 1)</option>
                            <option value="DB1.DBX0.2">DB1.DBX0.2 (Coil 2)</option>
                            <option value="DB1.DBX0.3">DB1.DBX0.3 (Coil 3)</option>
                            <option value="DB1.DBX0.4">DB1.DBX0.4 (Coil 4)</option>
                            <option value="DB1.DBX0.5">DB1.DBX0.5 (Coil 5)</option>
                            <option value="DB1.DBX0.6">DB1.DBX0.6 (Coil 6)</option>
                            <option value="DB1.DBX0.7">DB1.DBX0.7 (Coil 7)</option>
                        </optgroup>
                        <optgroup label="DB1 - Byte 1">
                            <option value="DB1.DBX1.0">DB1.DBX1.0 (Coil 8)</option>
                            <option value="DB1.DBX1.1">DB1.DBX1.1 (Coil 9)</option>
                            <option value="DB1.DBX1.2">DB1.DBX1.2 (Coil 10)</option>
                            <option value="DB1.DBX1.3">DB1.DBX1.3 (Coil 11)</option>
                            <option value="DB1.DBX1.4">DB1.DBX1.4 (Coil 12)</option>
                            <option value="DB1.DBX1.5">DB1.DBX1.5 (Coil 13)</option>
                            <option value="DB1.DBX1.6">DB1.DBX1.6 (Coil 14)</option>
                            <option value="DB1.DBX1.7">DB1.DBX1.7 (Coil 15)</option>
                        </optgroup>
                        <optgroup label="DB1 - Byte 2">
                            <option value="DB1.DBX2.0">DB1.DBX2.0 (Coil 16)</option>
                            <option value="DB1.DBX2.1">DB1.DBX2.1 (Coil 17)</option>
                            <option value="DB1.DBX2.2">DB1.DBX2.2 (Coil 18)</option>
                            <option value="DB1.DBX2.3">DB1.DBX2.3 (Coil 19)</option>
                            <option value="DB1.DBX2.4">DB1.DBX2.4 (Coil 20)</option>
                            <option value="DB1.DBX2.5">DB1.DBX2.5 (Coil 21)</option>
                            <option value="DB1.DBX2.6">DB1.DBX2.6 (Coil 22)</option>
                            <option value="DB1.DBX2.7">DB1.DBX2.7 (Coil 23)</option>
                        </optgroup>
                        <optgroup label="√ñzel Adresler">
                            <option value="0">Coil 0 (Direkt)</option>
                            <option value="1">Coil 1 (Direkt)</option>
                            <option value="2">Coil 2 (Direkt)</option>
                            <option value="3">Coil 3 (Direkt)</option>
                            <option value="4">Coil 4 (Direkt)</option>
                            <option value="5">Coil 5 (Direkt)</option>
                        </optgroup>
                    </select>
                </div>

                <button class="add-button" onclick="addPLCButton()">Buton Ekle</button>
            </div>

            <div class="control-section">
                <h2 class="section-title">PLC Butonlarƒ±</h2>
                <div class="plc-buttons" id="plcButtons">
                    <!-- Butonlar buraya dinamik olarak eklenecek -->
                </div>
            </div>

            <div class="status-panel">
                <h3 class="status-title">Durum Paneli</h3>
                <div class="status-item">
                    <span class="status-label">PLC Baƒülantƒ±sƒ±:</span>
                    <span class="status-value" id="connectionStatus">Sim√ºlasyon Modu</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Aktif Buton Sayƒ±sƒ±:</span>
                    <span class="status-value" id="activeButtonCount">0</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Son ƒ∞≈ülem:</span>
                    <span class="status-value" id="lastAction">-</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Modbus Protokol√º:</span>
                    <span class="status-value">Write Single Coil (0x05)</span>
                </div>
            </div>

            <div class="control-section">
                <h2 class="section-title">üìä Canlƒ± PLC Verileri</h2>
                <div class="data-grid" id="dataGrid">
                    <!-- Veriler buraya dinamik olarak eklenecek -->
                </div>
                <div class="data-controls">
                    <button class="add-button" onclick="toggleDataRefresh()" id="refreshButton">üîÑ Veri Yenilemeyi Ba≈ülat</button>
                    <span class="refresh-status" id="refreshStatus">Durduruldu</span>
                </div>
            </div>

            <div class="control-section" style="background: #fff3cd; border-left-color: #ffc107;">
                <h2 class="section-title">‚ö†Ô∏è √ñnemli Not</h2>
                <p style="color: #856404; margin-bottom: 15px;">
                    <strong>≈ûu anda sim√ºlasyon modunda √ßalƒ±≈üƒ±yor.</strong> Ger√ßek PLC baƒülantƒ±sƒ± i√ßin:
                </p>
                <ul style="color: #856404; margin-left: 20px;">
                    <li>Modbus TCP protokol√º kullanƒ±lƒ±yor (Port 502)</li>
                    <li>Write Single Coil (0x05) fonksiyonu ile bit yazƒ±lƒ±yor</li>
                    <li>Adres formatƒ±: DB1.DBX0.0 ‚Üí Modbus coil adresi 0</li>
                    <li>Ger√ßek baƒülantƒ± i√ßin backend servisi gerekli</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        let buttonCounter = 0;
        let currentButtonType = 'toggle';
        let activeButtons = new Set();
        let savedButtons = [];
        
        // Veri yenileme i√ßin deƒüi≈ükenler
        let dataRefreshInterval = null;
        let isDataRefreshing = false;
        let lastData = null;

        // LocalStorage'dan verileri y√ºkle
        function loadFromStorage() {
            const savedData = localStorage.getItem('plcTestData');
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    
                    // PLC adresini y√ºkle
                    if (data.plcAddress) {
                        document.getElementById('plcAddress').value = data.plcAddress;
                    }
                    
                    // Kaydedilmi≈ü butonlarƒ± y√ºkle
                    if (data.buttons && data.buttons.length > 0) {
                        savedButtons = data.buttons;
                        buttonCounter = data.buttonCounter || 0;
                        renderSavedButtons();
                        console.log(`‚úÖ ${savedButtons.length} buton y√ºklendi`);
                    }
                } catch (error) {
                    console.error('‚ùå LocalStorage veri y√ºkleme hatasƒ±:', error);
                    // Hatalƒ± veri varsa temizle
                    localStorage.removeItem('plcTestData');
                }
            }
        }

        // Verileri LocalStorage'a kaydet
        function saveToStorage() {
            try {
                const data = {
                    plcAddress: document.getElementById('plcAddress').value,
                    buttons: savedButtons,
                    buttonCounter: buttonCounter
                };
                localStorage.setItem('plcTestData', JSON.stringify(data));
                console.log(`üíæ ${savedButtons.length} buton kaydedildi`);
            } catch (error) {
                console.error('‚ùå LocalStorage kaydetme hatasƒ±:', error);
            }
        }

        // Kaydedilmi≈ü butonlarƒ± render et
        function renderSavedButtons() {
            const container = document.getElementById('plcButtons');
            container.innerHTML = '';
            
            savedButtons.forEach(buttonData => {
                const buttonHtml = `
                    <div class="plc-button ${buttonData.type}" id="${buttonData.id}" data-address="${buttonData.address}" data-type="${buttonData.type}">
                        <div class="button-label">
                            <span class="button-label-text">${buttonData.label}</span>
                            <span class="button-type-indicator ${buttonData.type}">${buttonData.type === 'toggle' ? 'T' : 'M'}</span>
                            <button class="edit-button" onclick="editButtonName('${buttonData.id}')" title="ƒ∞smi d√ºzenle">‚úèÔ∏è</button>
                            <button class="button-type-button" onclick="changeButtonType('${buttonData.id}')" title="T√ºr√º deƒüi≈ütir">üîÑ</button>
                        </div>
                        <div class="button-address">${buttonData.address}</div>
                        <div class="button-status">Kapalƒ±</div>
                        <button class="remove-button" onclick="removePLCButton('${buttonData.id}')">Kaldƒ±r</button>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', buttonHtml);
                
                // Buton olaylarƒ±nƒ± ekle
                const buttonElement = document.getElementById(buttonData.id);
                addButtonEvents(buttonElement);
            });
            
            // Durumu g√ºncelle
            updateStatus();
        }

        // Buton olaylarƒ±nƒ± ekle
        function addButtonEvents(buttonElement) {
            buttonElement.addEventListener('click', function(e) {
                // Kalem ikonu, kaldƒ±r butonu, t√ºr deƒüi≈ütirme butonu veya input alanƒ±na tƒ±klanƒ±rsa buton i≈ülevini √ßalƒ±≈ütƒ±rma
                if (e.target.classList.contains('remove-button') || 
                    e.target.classList.contains('edit-button') || 
                    e.target.classList.contains('button-type-button') ||
                    e.target.classList.contains('button-type-indicator') ||
                    e.target.classList.contains('edit-input') ||
                    e.target.tagName === 'INPUT') {
                    return;
                }
                
                const address = this.dataset.address;
                const type = this.dataset.type;
                
                if (type === 'toggle') {
                    toggleButton(this, address);
                }
                // Momentary butonlar i√ßin click olayƒ± yok, sadece mousedown/mouseup
            });

            // Momentary buton i√ßin mouse olaylarƒ±
            if (buttonElement.dataset.type === 'momentary') {
                let isPressed = false;
                let isMouseDown = false;
                
                // Mouse down - basƒ±lƒ± tutma ba≈ülangƒ±cƒ±
                buttonElement.addEventListener('mousedown', function(e) {
                    if (e.target.classList.contains('remove-button') || 
                        e.target.classList.contains('edit-button') || 
                        e.target.classList.contains('button-type-button') ||
                        e.target.classList.contains('button-type-indicator') ||
                        e.target.classList.contains('edit-input') ||
                        e.target.tagName === 'INPUT') return;
                    
                    if (e.button === 0 && !isPressed) { // Sadece sol tƒ±k ve hen√ºz basƒ±lƒ± deƒüil
                        e.preventDefault();
                        isPressed = true;
                        isMouseDown = true;
                        momentaryButton(this, this.dataset.address, true);
                    }
                });
                
                // Mouse up - basƒ±lƒ± tutma sonu
                buttonElement.addEventListener('mouseup', function(e) {
                    if (e.target.classList.contains('remove-button') || 
                        e.target.classList.contains('edit-button') || 
                        e.target.classList.contains('button-type-button') ||
                        e.target.classList.contains('button-type-indicator') ||
                        e.target.classList.contains('edit-input') ||
                        e.target.tagName === 'INPUT') return;
                    
                    if (e.button === 0 && isPressed) { // Sadece sol tƒ±k ve basƒ±lƒ± durumda
                        e.preventDefault();
                        isPressed = false;
                        isMouseDown = false;
                        momentaryButton(this, this.dataset.address, false);
                    }
                });
                
                // Mouse leave - fare butondan √ßƒ±karsa
                buttonElement.addEventListener('mouseleave', function(e) {
                    if (isPressed && isMouseDown) {
                        isPressed = false;
                        isMouseDown = false;
                        momentaryButton(this, this.dataset.address, false);
                    }
                });
                
                // Global mouse up - fare herhangi bir yerde bƒ±rakƒ±lƒ±rsa
                document.addEventListener('mouseup', function(e) {
                    if (isPressed && isMouseDown) {
                        isPressed = false;
                        isMouseDown = false;
                        momentaryButton(buttonElement, buttonElement.dataset.address, false);
                    }
                });
                
                // Klavye olaylarƒ± (Enter/Space)
                buttonElement.addEventListener('keydown', function(e) {
                    if (e.target.classList.contains('remove-button') || 
                        e.target.classList.contains('edit-button') || 
                        e.target.classList.contains('button-type-button') ||
                        e.target.classList.contains('button-type-indicator') ||
                        e.target.classList.contains('edit-input') ||
                        e.target.tagName === 'INPUT') return;
                    
                    if ((e.key === 'Enter' || e.key === ' ') && !isPressed) {
                        e.preventDefault();
                        isPressed = true;
                        momentaryButton(this, this.dataset.address, true);
                    }
                });
                
                buttonElement.addEventListener('keyup', function(e) {
                    if (e.target.classList.contains('remove-button') || 
                        e.target.classList.contains('edit-button') || 
                        e.target.classList.contains('button-type-button') ||
                        e.target.classList.contains('button-type-indicator') ||
                        e.target.classList.contains('edit-input') ||
                        e.target.tagName === 'INPUT') return;
                    
                    if ((e.key === 'Enter' || e.key === ' ') && isPressed) {
                        e.preventDefault();
                        isPressed = false;
                        momentaryButton(this, this.dataset.address, false);
                    }
                });
            }
        }

        // Varsayƒ±lan buton t√ºr√º
        currentButtonType = 'toggle';

        // PLC adresi deƒüi≈ütiƒüinde kaydet
        document.getElementById('plcAddress').addEventListener('input', function() {
            saveToStorage();
        });

        function addPLCButton() {
            const address = document.getElementById('newButtonAddress').value.trim();
            if (!address) {
                alert('L√ºtfen bir adres se√ßin!');
                return;
            }

            buttonCounter++;
            const buttonId = `button_${buttonCounter}`;
            
            // Buton verisini kaydet (varsayƒ±lan olarak toggle)
            const buttonData = {
                id: buttonId,
                address: address,
                type: 'toggle', // Varsayƒ±lan olarak toggle
                label: `Buton ${buttonCounter}`
            };
            savedButtons.push(buttonData);
            
            const buttonHtml = `
                <div class="plc-button toggle" id="${buttonId}" data-address="${address}" data-type="toggle">
                    <div class="button-label">
                        <span class="button-label-text">Buton ${buttonCounter}</span>
                        <span class="button-type-indicator toggle">T</span>
                        <button class="edit-button" onclick="editButtonName('${buttonId}')" title="ƒ∞smi d√ºzenle">‚úèÔ∏è</button>
                        <button class="button-type-button" onclick="changeButtonType('${buttonId}')" title="T√ºr√º deƒüi≈ütir">üîÑ</button>
                    </div>
                    <div class="button-address">${address}</div>
                    <div class="button-status">Kapalƒ±</div>
                    <button class="remove-button" onclick="removePLCButton('${buttonId}')">Kaldƒ±r</button>
                </div>
            `;

            document.getElementById('plcButtons').insertAdjacentHTML('beforeend', buttonHtml);

            // Buton olaylarƒ±nƒ± ekle
            const buttonElement = document.getElementById(buttonId);
            addButtonEvents(buttonElement);

            document.getElementById('newButtonAddress').selectedIndex = 0; // ƒ∞lk se√ßeneƒüi se√ß
            updateStatus();
            saveToStorage();
        }

        function removePLCButton(buttonId) {
            const button = document.getElementById(buttonId);
            const address = button.dataset.address;
            
            // Aktif butonlardan √ßƒ±kar
            activeButtons.delete(address);
            
            // Kaydedilmi≈ü butonlardan √ßƒ±kar
            savedButtons = savedButtons.filter(btn => btn.id !== buttonId);
            
            button.remove();
            updateStatus();
            updateLastAction(`Buton kaldƒ±rƒ±ldƒ±: ${address}`);
            saveToStorage();
        }


        function updateStatus() {
            document.getElementById('activeButtonCount').textContent = activeButtons.size;
            
            // PLC baƒülantƒ± durumu sim√ºlasyonu
            const connectionStatus = document.getElementById('connectionStatus');
            if (activeButtons.size > 0) {
                connectionStatus.textContent = 'Aktif';
                connectionStatus.style.color = '#27ae60';
            } else {
                connectionStatus.textContent = 'Baƒülƒ± Deƒüil';
                connectionStatus.style.color = '#e74c3c';
            }
        }

        function updateLastAction(action) {
            const now = new Date();
            const timeString = now.toLocaleTimeString('tr-TR');
            document.getElementById('lastAction').textContent = `${action} (${timeString})`;
        }

        // Buton t√ºr√ºn√º deƒüi≈ütirme fonksiyonu
        function changeButtonType(buttonId) {
            // Event propagation'ƒ± durdur
            event.stopPropagation();
            
            const buttonElement = document.getElementById(buttonId);
            const currentType = buttonElement.dataset.type;
            const newType = currentType === 'toggle' ? 'momentary' : 'toggle';
            
            // Buton elementini g√ºncelle
            buttonElement.className = `plc-button ${newType}`;
            buttonElement.dataset.type = newType;
            
            // T√ºr g√∂stergesini g√ºncelle
            const typeIndicator = buttonElement.querySelector('.button-type-indicator');
            typeIndicator.className = `button-type-indicator ${newType}`;
            typeIndicator.textContent = newType === 'toggle' ? 'T' : 'M';
            
            // SavedButtons array'inde g√ºncelle
            const buttonData = savedButtons.find(btn => btn.id === buttonId);
            if (buttonData) {
                buttonData.type = newType;
                saveToStorage();
            }
            
            // Buton olaylarƒ±nƒ± yeniden ekle
            addButtonEvents(buttonElement);
            
            updateLastAction(`Buton t√ºr√º deƒüi≈ütirildi: ${currentType} ‚Üí ${newType}`);
        }

        // Buton ismini d√ºzenleme fonksiyonu
        function editButtonName(buttonId) {
            // Event propagation'ƒ± durdur
            event.stopPropagation();
            
            const buttonElement = document.getElementById(buttonId);
            const labelTextElement = buttonElement.querySelector('.button-label-text');
            const currentName = labelTextElement.textContent;
            
            // Input olu≈ütur
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentName;
            input.className = 'edit-input';
            input.maxLength = 20; // Maksimum 20 karakter
            
            // Label'ƒ± input ile deƒüi≈ütir
            labelTextElement.style.display = 'none';
            labelTextElement.parentNode.insertBefore(input, labelTextElement);
            
            // Input'a odaklan ve metni se√ß
            input.focus();
            input.select();
            
            // Kaydetme fonksiyonu
            const saveName = () => {
                const newName = input.value.trim();
                if (newName && newName !== currentName) {
                    // Yeni ismi kaydet
                    labelTextElement.textContent = newName;
                    
                    // SavedButtons array'inde g√ºncelle
                    const buttonData = savedButtons.find(btn => btn.id === buttonId);
                    if (buttonData) {
                        buttonData.label = newName;
                        saveToStorage();
                    }
                    
                    updateLastAction(`Buton ismi deƒüi≈ütirildi: ${currentName} ‚Üí ${newName}`);
                } else {
                    // Deƒüi≈üiklik yoksa eski ismi geri y√ºkle
                    labelTextElement.textContent = currentName;
                }
                
                // Input'u kaldƒ±r ve label'ƒ± g√∂ster
                input.remove();
                labelTextElement.style.display = 'block';
            };
            
            // Enter tu≈üu ile kaydet
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveName();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    // ƒ∞ptal et
                    input.remove();
                    labelTextElement.style.display = 'block';
                }
            });
            
            // Input'tan √ßƒ±kƒ±nca kaydet
            input.addEventListener('blur', saveName);
        }

        // Adres formatƒ±nƒ± d√∂n√º≈üt√ºr (DB1.DBX0.0 -> 0)
        function parseAddress(addressString) {
            // DB1.DBX0.0 formatƒ±ndan sadece sayƒ±yƒ± √ßƒ±kar
            const match = addressString.match(/DB(\d+)\.DBX(\d+)\.(\d+)/);
            if (match) {
                const dbNumber = parseInt(match[1]);
                const byteOffset = parseInt(match[2]);
                const bitOffset = parseInt(match[3]);
                // Modbus coil adresi hesapla (DB1 = 0x0000, DB2 = 0x1000, vs.)
                return (dbNumber - 1) * 0x1000 + byteOffset * 8 + bitOffset;
            }
            
            // Eƒüer sadece sayƒ± ise direkt kullan
            const numericAddress = parseInt(addressString);
            if (!isNaN(numericAddress)) {
                return numericAddress;
            }
            
            throw new Error(`Ge√ßersiz adres formatƒ±: ${addressString}`);
        }

        // PLC'ye bit yazma fonksiyonlarƒ±
        async function writeBitToPLC(addressString, value) {
            const plcAddress = document.getElementById('plcAddress').value;
            if (!plcAddress) {
                alert('L√ºtfen PLC adresini girin!');
                return false;
            }

            try {
                // API'ye istek g√∂nder (timeout ile)
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 2000); // 2 saniye timeout
                
                const success = await sendToPLC(plcAddress, {
                    address: addressString,
                    value: value
                }, controller.signal);
                
                clearTimeout(timeoutId);
                
                if (success) {
                    updateLastAction(`Bit yazƒ±ldƒ±: ${addressString} = ${value ? '1' : '0'}`);
                    return true;
                } else {
                    updateLastAction(`Bit yazma hatasƒ±: ${addressString}`);
                    return false;
                }
            } catch (error) {
                console.error('PLC bit yazma hatasƒ±:', error);
                if (error.name === 'AbortError') {
                    updateLastAction(`Timeout: ${addressString}`);
                } else {
                    updateLastAction(`Hata: ${error.message}`);
                }
                return false;
            }
        }


        async function sendToPLC(plcAddress, request, signal) {
            // Ger√ßek PLC API'sine istek g√∂nder
            try {
                const response = await fetch('http://localhost:5000/api/plc/write-bit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        address: request.address,
                        value: request.value,
                        plc_ip: plcAddress
                    }),
                    signal: signal
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('‚úÖ PLC yazma ba≈üarƒ±lƒ±:', result.message);
                    return true;
                } else {
                    console.error('‚ùå PLC yazma hatasƒ±:', result.error);
                    return false;
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.error('‚ùå API timeout:', error);
                } else {
                    console.error('‚ùå API baƒülantƒ± hatasƒ±:', error);
                }
                return false;
            }
        }

        // Toggle buton i√ßin bit yazma
        function toggleButton(buttonElement, address) {
            const isActive = buttonElement.classList.contains('active');
            const newValue = !isActive;
            
            // PLC'ye bit yaz
            writeBitToPLC(address, newValue).then(success => {
                if (success) {
                    if (newValue) {
                        buttonElement.classList.add('active');
                        buttonElement.querySelector('.button-status').textContent = 'A√ßƒ±k';
                        activeButtons.add(address);
                    } else {
                        buttonElement.classList.remove('active');
                        buttonElement.querySelector('.button-status').textContent = 'Kapalƒ±';
                        activeButtons.delete(address);
                    }
                    updateStatus();
                } else {
                    // PLC yazma ba≈üarƒ±sƒ±z, buton durumunu deƒüi≈ütirme
                    console.log('PLC yazma ba≈üarƒ±sƒ±z, buton durumu deƒüi≈ütirilmedi');
                }
            });
        }

        // Momentary buton i√ßin bit yazma
        function momentaryButton(buttonElement, address, isPressed) {
            // PLC'ye bit yaz
            writeBitToPLC(address, isPressed).then(success => {
                if (success) {
                    if (isPressed) {
                        buttonElement.classList.add('active');
                        buttonElement.querySelector('.button-status').textContent = 'Basƒ±lƒ±';
                        activeButtons.add(address);
                        console.log(`Momentary ON: ${address} = TRUE`);
                    } else {
                        buttonElement.classList.remove('active');
                        buttonElement.querySelector('.button-status').textContent = 'Bƒ±rakƒ±ldƒ±';
                        activeButtons.delete(address);
                        console.log(`Momentary OFF: ${address} = FALSE`);
                    }
                    updateStatus();
                } else {
                    console.log('PLC yazma ba≈üarƒ±sƒ±z');
                    // Hata durumunda buton durumunu sƒ±fƒ±rla
                    buttonElement.classList.remove('active');
                    buttonElement.querySelector('.button-status').textContent = 'Hata';
                    activeButtons.delete(address);
                    updateStatus();
                }
            });
        }

        // Veri yenileme fonksiyonlarƒ±
        function toggleDataRefresh() {
            if (isDataRefreshing) {
                stopDataRefresh();
            } else {
                startDataRefresh();
            }
        }

        function startDataRefresh() {
            if (isDataRefreshing) return;
            
            isDataRefreshing = true;
            document.getElementById('refreshButton').textContent = '‚èπÔ∏è Veri Yenilemeyi Durdur';
            document.getElementById('refreshStatus').textContent = 'Aktif';
            document.getElementById('refreshStatus').className = 'refresh-status active';
            
            // ƒ∞lk veriyi hemen √ßek
            fetchPLCData();
            
            // Her 2 saniyede bir veri √ßek
            dataRefreshInterval = setInterval(fetchPLCData, 2000);
        }

        function stopDataRefresh() {
            if (!isDataRefreshing) return;
            
            isDataRefreshing = false;
            document.getElementById('refreshButton').textContent = 'üîÑ Veri Yenilemeyi Ba≈ülat';
            document.getElementById('refreshStatus').textContent = 'Durduruldu';
            document.getElementById('refreshStatus').className = 'refresh-status';
            
            if (dataRefreshInterval) {
                clearInterval(dataRefreshInterval);
                dataRefreshInterval = null;
            }
        }

        async function fetchPLCData() {
            try {
                const response = await fetch('http://192.168.1.44:8080/api/data');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                lastData = data;
                updateDataDisplay(data);
                
                // Ba≈üarƒ±lƒ± g√ºncelleme
                document.getElementById('refreshStatus').textContent = 'Aktif';
                document.getElementById('refreshStatus').className = 'refresh-status active';
                
            } catch (error) {
                console.error('Veri √ßekme hatasƒ±:', error);
                document.getElementById('refreshStatus').textContent = 'Hata';
                document.getElementById('refreshStatus').className = 'refresh-status error';
            }
        }

        function updateDataDisplay(data) {
            const dataGrid = document.getElementById('dataGrid');
            
            const dataCards = [
                { title: 'Makine Hƒ±zƒ±', value: data.MachineSpeed, unit: 'rpm', key: 'MachineSpeed' },
                { title: 'Die Hƒ±zƒ±', value: data.DieSpeed, unit: 'rpm', key: 'DieSpeed' },
                { title: 'Makine Durumu', value: data.MachineStopped ? 'DURDU' : '√áALI≈ûIYOR', unit: '', key: 'MachineStopped' },
                { title: 'Duru≈ü S√ºresi', value: data.StoppageDuration, unit: '', key: 'StoppageDuration' },
                { title: 'Toplam Duru≈ü S√ºresi', value: data.TotalStoppageDuration, unit: '', key: 'TotalStoppageDuration' },
                { title: 'Etil Alkol', value: data.EthylAlcoholConsumption, unit: 'L', key: 'EthylAlcoholConsumption' },
                { title: 'Etil Asetat', value: data.EthylAcetateConsumption, unit: 'L', key: 'EthylAcetateConsumption' },
                { title: 'Kaƒüƒ±t T√ºketimi', value: data.PaperConsumption, unit: 'm', key: 'PaperConsumption' },
                { title: 'Ger√ßek √úretim', value: data.ActualProduction, unit: 'adet', key: 'ActualProduction' },
                { title: 'Kalan ƒ∞≈ü', value: data.RemainingWork, unit: 'adet', key: 'RemainingWork' },
                { title: 'Tahmini S√ºre', value: data.EstimatedTime, unit: 'dk', key: 'EstimatedTime' },
                { title: 'Toplam Duru≈ü', value: data.TotalStops, unit: 'adet', key: 'TotalStops' },
                { title: 'Kurulum Duru≈üu', value: data.SetupStops, unit: 'adet', key: 'SetupStops' },
                { title: 'Arƒ±za Duru≈üu', value: data.FaultStops, unit: 'adet', key: 'FaultStops' },
                { title: 'Kalite Duru≈üu', value: data.QualityStops, unit: 'adet', key: 'QualityStops' },
                { title: 'Fire Oranƒ±', value: data.WastageRatio, unit: '%', key: 'WastageRatio' },
                { title: 'Fazla √úretim', value: data.OverProduction, unit: 'adet', key: 'OverProduction' },
                { title: 'Tamamlanma Oranƒ±', value: data.CompletionPercentage, unit: '%', key: 'CompletionPercentage' }
            ];
            
            dataGrid.innerHTML = '';
            
            dataCards.forEach(card => {
                const cardHtml = `
                    <div class="data-card" id="card-${card.key}">
                        <div class="data-card-header">
                            <div class="data-card-title">${card.title}</div>
                            <div class="data-card-status updated">G√ºncel</div>
                        </div>
                        <div class="data-card-value">
                            ${formatValue(card.value, card.key)}
                            <span class="data-card-unit">${card.unit}</span>
                        </div>
                    </div>
                `;
                dataGrid.insertAdjacentHTML('beforeend', cardHtml);
            });
        }

        function formatValue(value, key) {
            if (key === 'MachineStopped') {
                return value ? 'DURDU' : '√áALI≈ûIYOR';
            }
            
            // Duru≈ü s√ºreleri i√ßin √∂zel formatlama
            if (key === 'StoppageDuration' || key === 'TotalStoppageDuration') {
                return formatDuration(value);
            }
            
            if (typeof value === 'number') {
                if (value % 1 === 0) {
                    return value.toLocaleString('tr-TR');
                } else {
                    return value.toFixed(2);
                }
            }
            
            return value || '0';
        }

        function formatDuration(milliseconds) {
            if (!milliseconds || milliseconds === 0) {
                return '00:00:00';
            }
            
            // Milisaniyeyi saniyeye √ßevir
            const totalSeconds = Math.floor(milliseconds / 1000);
            
            // Saat, dakika, saniye hesapla
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            
            // Formatla (HH:MM:SS)
            const formattedHours = hours.toString().padStart(2, '0');
            const formattedMinutes = minutes.toString().padStart(2, '0');
            const formattedSeconds = seconds.toString().padStart(2, '0');
            
            return `${formattedHours}:${formattedMinutes}:${formattedSeconds}`;
        }

        // Sayfa y√ºklendiƒüinde verileri y√ºkle
        window.addEventListener('load', function() {
            loadFromStorage();
            
            // Eƒüer hi√ß buton yoksa √∂rnek butonlar ekle
            if (savedButtons.length === 0) {
                // √ñrnek butonlarƒ± ekle
                const exampleAddresses = ['DB1.DBX0.0', 'DB1.DBX0.1', 'DB1.DBX0.2'];
                
                exampleAddresses.forEach((address, index) => {
                    buttonCounter++;
                    const buttonId = `button_${buttonCounter}`;
                    
                    // Buton verisini kaydet
                    const buttonData = {
                        id: buttonId,
                        address: address,
                        type: 'toggle',
                        label: `Buton ${buttonCounter}`
                    };
                    savedButtons.push(buttonData);
                    
                    // Buton HTML'i olu≈ütur
                    const buttonHtml = `
                        <div class="plc-button toggle" id="${buttonId}" data-address="${address}" data-type="toggle">
                            <div class="button-label">
                                <span class="button-label-text">Buton ${buttonCounter}</span>
                                <span class="button-type-indicator toggle">T</span>
                                <button class="edit-button" onclick="editButtonName('${buttonId}')" title="ƒ∞smi d√ºzenle">‚úèÔ∏è</button>
                                <button class="button-type-button" onclick="changeButtonType('${buttonId}')" title="T√ºr√º deƒüi≈ütir">üîÑ</button>
                            </div>
                            <div class="button-address">${address}</div>
                            <div class="button-status">Kapalƒ±</div>
                            <button class="remove-button" onclick="removePLCButton('${buttonId}')">Kaldƒ±r</button>
                        </div>
                    `;
                    
                    document.getElementById('plcButtons').insertAdjacentHTML('beforeend', buttonHtml);
                    
                    // Buton olaylarƒ±nƒ± ekle
                    const buttonElement = document.getElementById(buttonId);
                    addButtonEvents(buttonElement);
                });
                
                // Kaydet
                saveToStorage();
            }
        });
    </script>
</body>
</html>
